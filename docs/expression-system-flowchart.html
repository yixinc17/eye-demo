<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çœ¼ç›è¡¨æƒ…ç³»ç»Ÿæ¶æ„æµç¨‹å›¾ v0.1</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 40px;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      color: #4ecdc4;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 40px;
      font-size: 14px;
    }
    .section {
      background: #16213e;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .section h2 {
      color: #ff6b6b;
      margin-bottom: 20px;
      font-size: 20px;
      border-left: 4px solid #ff6b6b;
      padding-left: 12px;
    }
    .section h3 {
      color: #feca57;
      margin: 20px 0 10px;
      font-size: 16px;
    }
    .section p {
      color: #aaa;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .mermaid {
      background: #0f0f23;
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      overflow-x: auto;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #ccc;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .note {
      background: rgba(78, 205, 196, 0.1);
      border-left: 3px solid #4ecdc4;
      padding: 12px 16px;
      margin: 15px 0;
      font-size: 13px;
      color: #4ecdc4;
    }
    .warning {
      background: rgba(255, 107, 107, 0.1);
      border-left: 3px solid #ff6b6b;
      padding: 12px 16px;
      margin: 15px 0;
      font-size: 13px;
      color: #ff6b6b;
    }
    ul {
      margin-left: 20px;
      color: #bbb;
      font-size: 14px;
    }
    li { margin: 8px 0; }
    code {
      background: #2d3436;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      color: #4ecdc4;
    }
  </style>
</head>
<body>
  <h1>ğŸ¾ çœ¼ç›è¡¨æƒ…ç³»ç»Ÿæ¶æ„æµç¨‹å›¾</h1>
  <p class="subtitle">v0.1 - å›¾å±‚ + å‚æ•° + å°‘é‡ç‰¹åˆ¶ç´ æçš„å¯ç»„åˆã€å¯æ‰©å±•è¡¨æƒ…ç³»ç»Ÿ</p>

  <!-- ==================== 1. ç³»ç»Ÿæ€»è§ˆ ==================== -->
  <div class="section">
    <h2>1. ç³»ç»Ÿæ€»è§ˆ</h2>
    <p>è¡¨æƒ…ç³»ç»Ÿæ ¸å¿ƒå…¬å¼ï¼š<code>è¡¨æƒ… = Pose + GazeBehavior + Overlay</code></p>
    
    <div class="mermaid">
flowchart TB
    subgraph Expression["ğŸ­ è¡¨æƒ… Expression"]
        direction TB
        E1["è¡¨æƒ…ID<br/>(idle/happy/sad...)"]
    end
    
    subgraph Pose["ğŸ“ Pose é™æ€å§¿æ€"]
        direction TB
        P1["openPose<br/>ççœ¼æ—¶çœ¼çš®å§¿æ€"]
        P2["closePose<br/>é—­çœ¼æ—¶çœ¼çš®å§¿æ€"]
        P3["pupilScaleBase<br/>ç³å­”åŸºç¡€å¤§å°"]
        P4["timing<br/>in/hold/out"]
    end
    
    subgraph Gaze["ğŸ‘ï¸ GazeBehavior çœ¼ç è¡Œä¸º"]
        direction TB
        G1["authority<br/>interactive/emotion"]
        G2["followGain<br/>-1/0/1"]
        G3["pattern<br/>breathing/anxious..."]
    end
    
    subgraph Overlay["âœ¨ Overlay å åŠ å±‚"]
        direction TB
        O1["overlay_layer<br/>happy/tears..."]
        O2["timing<br/>in/hold/out"]
        O3["animation<br/>scale/alpha"]
    end
    
    subgraph Blink["ğŸ˜Œ Blink çœ¨çœ¼è½¨é“"]
        direction TB
        B1["blinkPolicy<br/>off/low/normal/high"]
    end
    
    E1 --> Pose
    E1 --> Gaze
    E1 --> Overlay
    E1 -.-> Blink
    
    style Expression fill:#ff6b6b,color:#fff
    style Pose fill:#4ecdc4,color:#000
    style Gaze fill:#feca57,color:#000
    style Overlay fill:#a29bfe,color:#000
    style Blink fill:#636e72,color:#fff
    </div>
    
    <div class="legend">
      <div class="legend-item"><div class="legend-color" style="background:#ff6b6b"></div>è¡¨æƒ…å…¥å£</div>
      <div class="legend-item"><div class="legend-color" style="background:#4ecdc4"></div>Pose å§¿æ€æ§åˆ¶</div>
      <div class="legend-item"><div class="legend-color" style="background:#feca57"></div>Gaze çœ¼ç è¡Œä¸º</div>
      <div class="legend-item"><div class="legend-color" style="background:#a29bfe"></div>Overlay å åŠ æ•ˆæœ</div>
      <div class="legend-item"><div class="legend-color" style="background:#636e72"></div>Blink ç‹¬ç«‹è½¨é“</div>
    </div>
  </div>

  <!-- ==================== 2. æ¸²æŸ“å›¾å±‚ç»“æ„ ==================== -->
  <div class="section">
    <h2>2. æ¸²æŸ“å›¾å±‚ç»“æ„ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰</h2>
    <p>æ¯åªçœ¼ç›ç”±6å±‚å›¾å±‚ç»„æˆï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºä»ä¸‹åˆ°ä¸Šæ¸²æŸ“ï¼š</p>
    
    <div class="mermaid">
flowchart TB
    subgraph RenderStack["æ¸²æŸ“å †æ ˆ (ä»ä¸‹åˆ°ä¸Š)"]
        direction TB
        L1["â‘  eyeball çœ¼ç™½<br/>å›ºå®šåº•å›¾"]
        L2["â‘¡ pupil ç³å­”/è™¹è†œ<br/>ä½ç½®: gazeBehavior<br/>å°ºå¯¸: pupilScale + pattern"]
        L3["â‘¢ highlight é«˜å…‰<br/>è·Ÿéšç³å­”ï¼Œå¹…åº¦è¾ƒå°"]
        L4["â‘£ overlay å åŠ å±‚ (å¯é€‰)<br/>ç¬¦å·/æ˜Ÿæ˜Ÿçœ¼/æ³ªå…‰ç­‰<br/>å¯å¸¦åŠ¨ç”»ï¼Œå¯æŒ‡å®šå±‚çº§"]
        L5["â‘¤ eyelidLower ä¸‹çœ¼çš®<br/>å¹³ç§» + å¯é€‰æ—‹è½¬"]
        L6["â‘¥ eyelidUpper ä¸Šçœ¼çš®<br/>å¹³ç§» + å¯é€‰æ—‹è½¬"]
        
        L1 --> L2 --> L3 --> L4 --> L5 --> L6
    end
    
    subgraph Controls["æ§åˆ¶å‚æ•°"]
        C1["Pose.upper<br/>{x, y, rot}"]
        C2["Pose.lower<br/>{x, y, rot}"]
        C3["pupilScale<br/>+ pattern.scaleOffset"]
        C4["gaze.offset<br/>+ followGain"]
    end
    
    C1 --> L6
    C2 --> L5
    C3 --> L2
    C4 --> L2
    C4 -.->|"å¹…åº¦ 0.3"| L3
    
    style L1 fill:#dfe6e9,color:#2d3436
    style L2 fill:#2d3436,color:#fff
    style L3 fill:#ffeaa7,color:#2d3436
    style L4 fill:#a29bfe,color:#fff
    style L5 fill:#fab1a0,color:#2d3436
    style L6 fill:#fab1a0,color:#2d3436
    </div>
    
    <div class="note">
      ğŸ’¡ Overlay çš„å±‚çº§å¯é€šè¿‡ <code>overlay_layer</code> å‚æ•°è°ƒæ•´ï¼Œé»˜è®¤åœ¨çœ¼çš®ä¹‹ä¸‹
    </div>
  </div>

  <!-- ==================== 3. Pose é™æ€å§¿æ€ç³»ç»Ÿ ==================== -->
  <div class="section">
    <h2>3. Pose é™æ€å§¿æ€ç³»ç»Ÿ</h2>
    <p>Pose å†³å®š"çœ‹èµ·æ¥åƒä»€ä¹ˆè„¸"ï¼ŒåŒ…å«çœ¼çš®å§¿æ€å’Œç³å­”å‚æ•°</p>
    
    <div class="mermaid">
flowchart LR
    subgraph PoseDef["Pose å®šä¹‰"]
        direction TB
        PD1["openPose<br/>ä¸Š/ä¸‹çœ¼çš® {x, y, rot}"]
        PD2["closePose (å¯é€‰)<br/>é—­çœ¼æ—¶çš„å§¿æ€"]
        PD3["pupilScaleBase<br/>ç³å­”åŸºç¡€å¤§å°"]
        PD4["timing<br/>{in, hold, out}"]
    end
    
    subgraph Examples["ç¤ºä¾‹ Pose"]
        direction TB
        E1["idle<br/>upper.y=-240, rot=0<br/>pupilScale=0.7"]
        E2["angry<br/>upper.y=-140, rot=Â±0.35<br/>pupilScale=0.6"]
        E3["sad<br/>upper.y=-100, rot=âˆ“0.2<br/>pupilScale=0.65"]
        E4["sleepy<br/>å¸¦ eyelidAnimation<br/>ä¸Šä¸‹çœ¼çš®å¾ªç¯åŠ¨ç”»"]
    end
    
    PoseDef --> Examples
    
    style PD1 fill:#4ecdc4,color:#000
    style PD2 fill:#4ecdc4,color:#000
    style PD3 fill:#4ecdc4,color:#000
    style PD4 fill:#4ecdc4,color:#000
    </div>
    
    <h3>çœ¼çš®ä½ç½®è®¡ç®—</h3>
    <div class="mermaid">
flowchart TB
    subgraph Calc["åŠ¨æ€è®¡ç®— (åŸºäºå›¾ç‰‡å°ºå¯¸)"]
        CA["eyeballRadius = 120px"]
        CB["lowerCloseY = radius - lidHeight/2"]
        CC["lowerOpenY = radius + lidHeight/2"]
        CD["upperOpenY = -eyeSize (å‡ºç”»)"]
    end
    
    subgraph Apply["åº”ç”¨ä½ç½®"]
        A1["upper.y: -240 (å¼€) â†’ 0 (é—­)"]
        A2["lower.y: 172 (å¼€) â†’ 69 (é—­)"]
    end
    
    Calc --> Apply
    </div>
  </div>

  <!-- ==================== 4. GazeBehavior çœ¼ç è¡Œä¸º ==================== -->
  <div class="section">
    <h2>4. GazeBehavior çœ¼ç è¡Œä¸ºè§„åˆ™</h2>
    <p>å†³å®š"çœ¼ç æ€ä¹ˆåŠ¨"ï¼Œç”¨äºåŒºåˆ†ç›¸ä¼¼è¡¨æƒ…</p>
    
    <div class="mermaid">
flowchart TB
    subgraph Authority["Authority æ§åˆ¶æƒ"]
        direction LR
        A1["interactive<br/>ä»¥ç”¨æˆ·/ç›®æ ‡ä¸ºä¸»<br/>å¼ºè·Ÿéš"]
        A2["blend<br/>è¡¨æƒ…è‡ªå¸¦åŠ¨ä½œ<br/>+ è½»åº¦è·Ÿéš"]
        A3["emotion<br/>å®Œå…¨è¡¨æƒ…è‡ªå¸¦<br/>ç¥æ¸¸/æ€è€ƒ/ç¡çœ "]
    end
    
    subgraph FollowGain["FollowGain è·Ÿéšæ¨¡å¼"]
        direction LR
        F1["+1 æ­£å‘è·Ÿéš"]
        F2["0 ä¸è·Ÿéš"]
        F3["-1 åå‘è·Ÿéš"]
    end
    
    subgraph Pattern["Pattern åŠ¨ç”»æ¨¡å¼"]
        direction LR
        P1["breathing<br/>å‘¼å¸æ„Ÿç¼©æ”¾"]
        P2["anxious_loop<br/>æ‹…å¿ƒå·¦å³å¾ªç¯"]
        P3["up_scan<br/>æ€è€ƒä¸Šè§†æ…¢æ‰«"]
        P4["micro_jitter<br/>è½»å¾®é¢¤åŠ¨"]
    end
    
    Input["ç”¨æˆ·è¾“å…¥<br/>é¼ æ ‡/è§¦æ‘¸"] --> Authority
    Authority -->|"interactive"| A1
    Authority -->|"blend"| A2
    Authority -->|"emotion"| A3
    
    A1 --> FollowGain
    A2 --> FollowGain
    A3 -.->|"å¿½ç•¥"| FollowGain
    
    FollowGain --> Pattern
    Pattern --> Output["æœ€ç»ˆç³å­”ä½ç½®<br/>offset + follow + pattern"]
    
    style Authority fill:#feca57,color:#000
    style FollowGain fill:#fd79a8,color:#000
    style Pattern fill:#74b9ff,color:#000
    </div>
    
    <div class="mermaid">
flowchart LR
    subgraph Update["ç³å­”ä½ç½®æ›´æ–°æµç¨‹"]
        U1["è¯»å– Pose.pupil.offset<br/>åŸºç¡€åç§»"]
        U2["æ£€æŸ¥ authority"]
        U3["è®¡ç®— follow è·Ÿéš"]
        U4["å åŠ  pattern åŠ¨ç”»"]
        U5["è®¾ç½® targetPupil"]
        U6["lerp å¹³æ»‘è¿‡æ¸¡"]
        
        U1 --> U2 --> U3 --> U4 --> U5 --> U6
    end
    </div>
  </div>

  <!-- ==================== 5. Overlay å åŠ å±‚ ==================== -->
  <div class="section">
    <h2>5. Overlay å åŠ å±‚ç³»ç»Ÿ</h2>
    <p>åªåœ¨ Pose + Gaze ä¸å¤Ÿè¡¨è¾¾æ—¶ä½¿ç”¨</p>
    
    <div class="mermaid">
flowchart TB
    subgraph Trigger["è§¦å‘ Overlay"]
        T1["setEmotion('happy')"]
        T2["emotion.overlay = 'happy_L'"]
    end
    
    subgraph Phases["Overlay é˜¶æ®µ"]
        direction LR
        P1["in æ¸å…¥<br/>opacity: 0â†’255"]
        P2["hold ä¿æŒ<br/>opacity: 255"]
        P3["out æ¸å‡º<br/>opacity: 255â†’0"]
        P4["none ç»“æŸ<br/>åˆ‡å› idle"]
        
        P1 -->|"timing.in"| P2
        P2 -->|"timing.hold"| P3
        P3 -->|"timing.out"| P4
    end
    
    Trigger --> P1
    
    subgraph Types["Overlay ç±»å‹"]
        O1["happy å¼€å¿ƒå¼§çº¿"]
        O2["star_eyes æ˜Ÿæ˜Ÿçœ¼"]
        O3["tears æ³ªå…‰"]
        O4["heart çˆ±å¿ƒ"]
        O5["imprint å°è®°"]
    end
    
    style P1 fill:#55efc4,color:#000
    style P2 fill:#00b894,color:#fff
    style P3 fill:#fdcb6e,color:#000
    style P4 fill:#636e72,color:#fff
    </div>
  </div>

  <!-- ==================== 6. Blink çœ¨çœ¼ç³»ç»Ÿ ==================== -->
  <div class="section">
    <h2>6. Blink çœ¨çœ¼ç³»ç»Ÿï¼ˆç‹¬ç«‹è½¨é“ï¼‰</h2>
    <p>Blink æ˜¯ç‹¬ç«‹è½¨é“ï¼Œä¸æ˜¯è¡¨æƒ…æœ¬ä½“ï¼ŒåŸºäºå½“å‰è¡¨æƒ…çš„ openPoseâ†’closePose æ’å€¼</p>
    
    <div class="mermaid">
flowchart TB
    subgraph Policy["BlinkPolicy ç­–ç•¥"]
        direction LR
        BP1["off<br/>ç¦ç”¨çœ¨çœ¼"]
        BP2["low<br/>4-7ç§’/æ¬¡"]
        BP3["normal<br/>3-5ç§’/æ¬¡"]
        BP4["high<br/>2-4ç§’/æ¬¡"]
        BP5["micro_only<br/>ä»…å¾®çœ¨"]
    end
    
    subgraph Process["çœ¨çœ¼æµç¨‹"]
        direction TB
        S1["è®¡æ—¶å™¨ç´¯åŠ "]
        S2{"è¾¾åˆ° nextTime?"}
        S3["è§¦å‘çœ¨çœ¼"]
        S4["é—­çœ¼é˜¶æ®µ<br/>progress: 0â†’1"]
        S5["ççœ¼é˜¶æ®µ<br/>progress: 1â†’0"]
        S6["é‡ç½®è®¡æ—¶å™¨<br/>éšæœºä¸‹æ¬¡æ—¶é—´"]
        
        S1 --> S2
        S2 -->|"æ˜¯"| S3
        S2 -->|"å¦"| S1
        S3 --> S4 --> S5 --> S6 --> S1
    end
    
    subgraph Interpolate["å§¿æ€æ’å€¼"]
        I1["openPose (å½“å‰è¡¨æƒ…)"]
        I2["closePose (é€šç”¨/è¡¨æƒ…ä¸“ç”¨)"]
        I3["lerp(open, close, progress)"]
        
        I1 --> I3
        I2 --> I3
    end
    
    Policy --> Process
    Process --> Interpolate
    
    style BP1 fill:#636e72,color:#fff
    style S4 fill:#ff7675,color:#fff
    style S5 fill:#74b9ff,color:#000
    </div>
    
    <div class="warning">
      âš ï¸ çœ¨çœ¼ç¦ç”¨åœºæ™¯ï¼šè¡¨æƒ…è¿‡æ¸¡æœŸé—´ã€Overlay æ¿€æ´»æ—¶ã€blinkPolicy=offï¼ˆå¦‚ angry çªçœ¼ï¼‰
    </div>
  </div>

  <!-- ==================== 7. è¡¨æƒ…åˆ‡æ¢æµç¨‹ ==================== -->
  <div class="section">
    <h2>7. è¡¨æƒ…åˆ‡æ¢ä¸è¿‡æ¸¡æœºåˆ¶</h2>
    <p>ç»Ÿä¸€è°ƒåº¦ï¼Œä¸ç¡¬é—ªã€ä¸æ‹–å»¶</p>
    
    <div class="mermaid">
flowchart TB
    subgraph Trigger["è§¦å‘åˆ‡æ¢"]
        T1["setEmotion(newId)"]
    end
    
    subgraph Prepare["å‡†å¤‡è¿‡æ¸¡"]
        P1["è®°å½• fromPose"]
        P2["è·å– toPose"]
        P3["è·å– duration"]
        P4["å¤„ç† Overlay"]
    end
    
    subgraph Transition["è¿‡æ¸¡åŠ¨ç”»"]
        TR1["transition.active = true"]
        TR2["timer += deltaTime"]
        TR3["progress = timer/duration"]
        TR4["easedT = easeOutCubic(t)"]
        TR5["lerp(fromPose, toPose, easedT)"]
        TR6["lerp(fromScale, toScale, easedT)"]
    end
    
    subgraph Complete["è¿‡æ¸¡å®Œæˆ"]
        C1["transition.active = false"]
        C2["å¯åŠ¨ eyelidAnimation (å¦‚æœ‰)"]
        C3["å¯åŠ¨ Blink (æŒ‰ policy)"]
    end
    
    T1 --> P1 --> P2 --> P3 --> P4
    P4 --> TR1 --> TR2 --> TR3 --> TR4
    TR4 --> TR5 --> TR6
    TR6 -->|"t >= 1"| C1
    C1 --> C2 --> C3
    
    style TR1 fill:#fdcb6e,color:#000
    style TR5 fill:#74b9ff,color:#000
    style C1 fill:#55efc4,color:#000
    </div>
    
    <h3>æ‰“æ–­ç­–ç•¥ (interrupt)</h3>
    <div class="mermaid">
flowchart LR
    subgraph Interrupt["æ‰“æ–­ç±»å‹"]
        I1["soft<br/>å…è®¸æ‰“æ–­ï¼Œèµ°çŸ­ out"]
        I2["hard<br/>ç«‹å³åˆ‡å…¥"]
        I3["never<br/>ä¸å¯æ‰“æ–­"]
    end
    
    subgraph Bridge["Bridge è¿‡æ¸¡ (å¯é€‰)"]
        B1["daze â†’ wakeup â†’ idle"]
        B2["sleepy â†’ sleep"]
        B3["sleep â†’ wakeup"]
    end
    </div>
  </div>

  <!-- ==================== 8. æ™®é€š Pose vs åºåˆ— Sequence ==================== -->
  <div class="section">
    <h2>8. æ™®é€š Pose vs åºåˆ— Sequence</h2>
    
    <div class="mermaid">
flowchart TB
    subgraph NormalPose["A. æ™®é€šè¡¨æƒ… (ç»å¤§å¤šæ•°)"]
        direction TB
        N1["å•ä¸€ Pose å…³é”®å¸§"]
        N2["timing: in/hold/out"]
        N3["gaze: authority + follow + pattern"]
        N4["blinkPolicy: æŒ‰éœ€"]
        N5["overlay: å¯é€‰"]
        
        N1 --> N2 --> N3 --> N4 --> N5
    end
    
    subgraph Sequence["B. åºåˆ—è¡¨æƒ… (sleepy/wakeupç­‰)"]
        direction TB
        S1["keyframes å…³é”®å¸§æ•°ç»„"]
        S2["æ¯å¸§: {time, pose, pupil, gaze, overlay}"]
        S3["gazeAuthority = emotion"]
        S4["blinkPolicy = off"]
        S5["å¤šæ®µåŠ¨ä½œæè¿°<br/>(çœ¼çš®ä¸Šä¸‹å¤šæ¬¡)"]
        
        S1 --> S2 --> S3 --> S4 --> S5
    end
    
    subgraph Examples["ç¤ºä¾‹"]
        E1["idle/happy/sad/angry<br/>â†’ æ™®é€š Pose"]
        E2["sleepy (çœ¼çš®ä¸Šä¸‹å¾ªç¯)<br/>wakeup (å¤šæ®µå”¤é†’)<br/>â†’ åºåˆ— Sequence"]
    end
    
    NormalPose --> E1
    Sequence --> E2
    
    style NormalPose fill:#4ecdc4,color:#000
    style Sequence fill:#a29bfe,color:#000
    </div>
    
    <div class="note">
      ğŸ’¡ å½“å‰ä»£ç ä¸­ <code>sleepy</code> ä½¿ç”¨ <code>eyelidAnimation</code> å®ç°å¾ªç¯åŠ¨ç”»ï¼Œå±äºåºåˆ—è¡¨æƒ…çš„ç®€åŒ–å½¢å¼
    </div>
  </div>

  <!-- ==================== 9. ä¸»å¾ªç¯ draw() ==================== -->
  <div class="section">
    <h2>9. ä¸»å¾ªç¯ draw() æµç¨‹</h2>
    
    <div class="mermaid">
flowchart TB
    subgraph MainLoop["draw() æ¯å¸§æ‰§è¡Œ"]
        direction TB
        D1["handleBlink()<br/>å¤„ç†çœ¨çœ¼"]
        D2["updateEyelidAnimation()<br/>çœ¼çš®å¾ªç¯åŠ¨ç”»"]
        D3["updatePattern()<br/>å‘¼å¸æ„Ÿ pattern"]
        D4["updatePupilFromMouse()<br/>ç³å­”è·Ÿéš"]
        D5["updateOverlay()<br/>å åŠ å±‚é˜¶æ®µ"]
        D6["smoothUpdate()<br/>å¹³æ»‘æ’å€¼"]
        D7["drawEye(left)"]
        D8["drawEye(right)"]
        
        D1 --> D2 --> D3 --> D4 --> D5 --> D6 --> D7 --> D8
    end
    
    subgraph DrawEye["drawEye() å›¾å±‚ç»˜åˆ¶"]
        direction TB
        E1["è®¡ç®— eyelidPose"]
        E2["åˆ›å»ºæ¤­åœ†é®ç½©"]
        E3["ç»˜åˆ¶ eyeball"]
        E4["ç»˜åˆ¶ pupil (ä½ç½®+ç¼©æ”¾)"]
        E5["ç»˜åˆ¶ highlight"]
        E6["ç»˜åˆ¶ eyelidLower"]
        E7["ç»˜åˆ¶ eyelidUpper"]
        E8["ç»˜åˆ¶ overlay (å¦‚æœ‰)"]
        E9["ç»“æŸé®ç½©"]
        
        E1 --> E2 --> E3 --> E4 --> E5 --> E6 --> E7 --> E8 --> E9
    end
    
    D7 --> DrawEye
    D8 --> DrawEye
    </div>
  </div>

  <!-- ==================== 10. Idle ç³»ç»Ÿ ==================== -->
  <div class="section">
    <h2>10. Idle ç©ºé—²ç³»ç»Ÿ</h2>
    <p>Idle æ˜¯ä¸€ç»„"ä½å¼ºåº¦è¡¨æƒ…/åŠ¨ä½œç»„åˆ"çš„é›†åˆï¼Œåœ¨æ— äº¤äº’æ—¶å¾ªç¯è§¦å‘</p>
    
    <div class="mermaid">
flowchart TB
    subgraph IdleSystem["Idle ç³»ç»Ÿ"]
        direction TB
        I1["æ— äº¤äº’æ£€æµ‹"]
        I2["é€‰æ‹© idle å˜ä½“<br/>(idle1/2/3/4)"]
        I3["åº”ç”¨ Pose + Gaze"]
        I4["è½»å¾® pattern<br/>å‘¼å¸/å¾®æ‰«è§†"]
        I5["å¶å‘çœ¨çœ¼"]
        I6["å¾ªç¯åˆ‡æ¢"]
        
        I1 --> I2 --> I3 --> I4 --> I5 --> I6 --> I2
    end
    
    subgraph IdleVariants["Idle å˜ä½“ç¤ºä¾‹"]
        V1["idle1: å¹³é™å‘¼å¸"]
        V2["idle2: å·¦å³å¾®æ‰«"]
        V3["idle3: å¶å°”çœ¨çœ¼"]
        V4["idle4: è½»å¾®å¥½å¥‡"]
    end
    
    IdleSystem --> IdleVariants
    
    style IdleSystem fill:#636e72,color:#fff
    </div>
  </div>

  <!-- ==================== 11. è¡¨æƒ…æ•°æ®è¡¨æ ¼ ==================== -->
  <div class="section">
    <h2>11. è¡¨æƒ…æ•°æ®ä¸€è§ˆè¡¨</h2>
    
    <h3>ğŸ“‹ è¡¨æƒ…ç»„åˆæ€»è¡¨</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>è¡¨æƒ… ID</th>
          <th>Authority</th>
          <th>Blink</th>
          <th>Overlay</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-idle">idle</span></td>
          <td>interactive</td>
          <td>slow (4-7s)</td>
          <td>â€”</td>
          <td>400ms</td>
        </tr>
        <tr>
          <td><span class="tag tag-happy">happy</span></td>
          <td>interactive</td>
          <td>off</td>
          <td>happy_L âœ¨</td>
          <td>200ms</td>
        </tr>
        <tr>
          <td><span class="tag tag-sad">sad</span></td>
          <td>emotion</td>
          <td>slow (4-7s)</td>
          <td>â€”</td>
          <td>800ms</td>
        </tr>
        <tr>
          <td><span class="tag tag-angry">angry</span></td>
          <td>interactive</td>
          <td>off</td>
          <td>â€”</td>
          <td>400ms</td>
        </tr>
        <tr>
          <td><span class="tag tag-sleepy">sleepy</span></td>
          <td>emotion</td>
          <td>off</td>
          <td>â€”</td>
          <td>800ms</td>
        </tr>
        <tr>
          <td><span class="tag tag-adore">adore</span></td>
          <td>interactive</td>
          <td>slow (4-7s)</td>
          <td>â€”</td>
          <td>200ms</td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ‘ï¸ ç³å­”å‚æ•°è¡¨</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>è¡¨æƒ…</th>
          <th>Scale</th>
          <th>Offset (x, y)</th>
          <th>Follow</th>
          <th>Pattern</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-idle">idle</span></td>
          <td>0.70</td>
          <td>(0, 0)</td>
          <td>+1 æ­£å‘</td>
          <td>neutral (Â±3%, 3s)</td>
        </tr>
        <tr>
          <td><span class="tag tag-happy">happy</span></td>
          <td>0.75</td>
          <td>(0, 0)</td>
          <td>+1 æ­£å‘</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><span class="tag tag-sad">sad</span></td>
          <td>0.65</td>
          <td>(0, 15)</td>
          <td>0 ä¸è·Ÿéš</td>
          <td>calm (Â±2%, 4s)</td>
        </tr>
        <tr>
          <td><span class="tag tag-angry">angry</span></td>
          <td>0.60</td>
          <td>(0, 0)</td>
          <td>-1 åå‘</td>
          <td>anxious (Â±5%, 1.5s)</td>
        </tr>
        <tr>
          <td><span class="tag tag-sleepy">sleepy</span></td>
          <td>0.70</td>
          <td>(0, 15)</td>
          <td>0 ä¸è·Ÿéš</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><span class="tag tag-adore">adore</span></td>
          <td>0.90</td>
          <td>(0, 0)</td>
          <td>+1 æ­£å‘</td>
          <td>calm (Â±2%, 4s)</td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ‘€ çœ¼çš®å§¿æ€è¡¨ (ä¸Šçœ¼çš® Upper)</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>è¡¨æƒ…</th>
          <th>å·¦çœ¼ L</th>
          <th>å³çœ¼ R</th>
          <th>è¯´æ˜</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-idle">idle</span></td>
          <td>x:0, y:-240, rot:0</td>
          <td>x:0, y:-240, rot:0</td>
          <td>å®Œå…¨çå¼€ï¼ˆå‡ºç”»ï¼‰</td>
        </tr>
        <tr>
          <td><span class="tag tag-happy">happy</span></td>
          <td>x:0, y:-220, rot:0</td>
          <td>x:0, y:-220, rot:0</td>
          <td>å¾®çœ¯ï¼ˆç•¥ä¸‹ç§» 20pxï¼‰</td>
        </tr>
        <tr>
          <td><span class="tag tag-sad">sad</span></td>
          <td>x:0, y:-100, rot:-0.2</td>
          <td>x:0, y:-100, rot:+0.2</td>
          <td>å…«å­—çœ‰ï¼ˆä¸‹å‚ + å†…æ—‹ï¼‰</td>
        </tr>
        <tr>
          <td><span class="tag tag-angry">angry</span></td>
          <td>x:+30, y:-140, rot:+0.35</td>
          <td>x:-30, y:-140, rot:-0.35</td>
          <td>å€’å…«å­—ï¼ˆå¤–ç§» + å¤–æ—‹ï¼‰</td>
        </tr>
        <tr>
          <td><span class="tag tag-sleepy">sleepy</span></td>
          <td>x:0, y:-100, rot:0</td>
          <td>x:0, y:-100, rot:0</td>
          <td>åŠé—­ï¼ˆå¸¦å¾ªç¯åŠ¨ç”»ï¼‰</td>
        </tr>
        <tr>
          <td><span class="tag tag-adore">adore</span></td>
          <td>x:0, y:-240, rot:0</td>
          <td>x:0, y:-240, rot:0</td>
          <td>å®Œå…¨çå¼€ + å¤§ç³å­”</td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ”„ ç‰¹æ®ŠåŠ¨ç”»é…ç½®</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>è¡¨æƒ…</th>
          <th>åŠ¨ç”»ç±»å‹</th>
          <th>å‚æ•°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-sleepy">sleepy</span></td>
          <td>eyelidAnimation</td>
          <td>upper: [-100, 0] / 5s<br/>lower: [130, 69] / 4.5s</td>
        </tr>
        <tr>
          <td><span class="tag tag-happy">happy</span></td>
          <td>overlay (happy_L)</td>
          <td>in: 500ms, hold: 3s, out: 500ms</td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ­ Pattern å‘¼å¸åŠ¨ç”»</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Pattern</th>
          <th>å±æ€§</th>
          <th>å¹…åº¦</th>
          <th>å‘¨æœŸ</th>
          <th>ä½¿ç”¨è¡¨æƒ…</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>calm</td>
          <td>scale</td>
          <td>Â±2%</td>
          <td>4s</td>
          <td>sad, adore</td>
        </tr>
        <tr>
          <td>neutral</td>
          <td>scale</td>
          <td>Â±3%</td>
          <td>3s</td>
          <td>idle</td>
        </tr>
        <tr>
          <td>anxious</td>
          <td>scale</td>
          <td>Â±5%</td>
          <td>1.5s</td>
          <td>angry</td>
        </tr>
      </tbody>
    </table>
  </div>

  <style>
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 13px;
    }
    .data-table th, .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    .data-table th {
      background: #0d0d0d;
      color: #4ecdc4;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table tr:hover {
      background: rgba(78, 205, 196, 0.05);
    }
    .data-table td {
      color: #ccc;
    }
    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .tag-idle { background: #636e72; color: #fff; }
    .tag-happy { background: #ffc107; color: #333; }
    .tag-sad { background: #17a2b8; color: #fff; }
    .tag-angry { background: #dc3545; color: #fff; }
    .tag-sleepy { background: #6c757d; color: #fff; }
    .tag-adore { background: #e91e63; color: #fff; }
  </style>

  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#4ecdc4',
        primaryTextColor: '#fff',
        primaryBorderColor: '#4ecdc4',
        lineColor: '#888',
        secondaryColor: '#ff6b6b',
        tertiaryColor: '#feca57',
        background: '#16213e',
        mainBkg: '#16213e',
        nodeBorder: '#4ecdc4',
        clusterBkg: 'rgba(78, 205, 196, 0.1)',
        clusterBorder: '#4ecdc4',
        titleColor: '#fff',
        edgeLabelBackground: '#16213e'
      },
      flowchart: {
        htmlLabels: true,
        curve: 'basis',
        nodeSpacing: 50,
        rankSpacing: 50
      }
    });
  </script>
</body>
</html>
